<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listplicity AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: 
                linear-gradient(135deg, rgba(26,26,26,0.85) 0%, rgba(51,51,51,0.75) 50%, rgba(26,26,26,0.85) 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><rect fill="%2387CEEB" width="1200" height="400"/><ellipse cx="150" cy="80" rx="50" ry="30" fill="%23FFFFFF" opacity="0.8"/><ellipse cx="300" cy="60" rx="40" ry="25" fill="%23FFFFFF" opacity="0.6"/><ellipse cx="450" cy="90" rx="35" ry="20" fill="%23FFFFFF" opacity="0.7"/><ellipse cx="600" cy="70" rx="45" ry="28" fill="%23FFFFFF" opacity="0.8"/><ellipse cx="750" cy="85" rx="38" ry="22" fill="%23FFFFFF" opacity="0.6"/><ellipse cx="900" cy="65" rx="42" ry="26" fill="%23FFFFFF" opacity="0.7"/><ellipse cx="1050" cy="95" rx="48" ry="30" fill="%23FFFFFF" opacity="0.8"/><rect fill="%2334C759" x="0" y="400" width="1200" height="400"/><circle cx="200" cy="350" r="60" fill="%23228B22"/><circle cx="400" cy="320" r="80" fill="%23228B22"/><circle cx="600" cy="340" r="70" fill="%23228B22"/><circle cx="800" cy="330" r="85" fill="%23228B22"/><circle cx="1000" cy="345" r="65" fill="%23228B22"/><polygon points="500,250 450,300 550,300" fill="%23D2691E"/><rect x="475" y="300" width="50" height="60" fill="%23F5DEB3"/><rect x="485" y="320" width="12" height="20" fill="%23654321"/><polygon points="485,315 497,315 497,310 491,305 485,310" fill="%23654321"/><rect x="505" y="310" width="15" height="15" fill="%2387CEEB"/><rect x="508" y="313" width="4" height="4" fill="%23654321"/><rect x="513" y="313" width="4" height="4" fill="%23654321"/><rect x="508" y="318" width="4" height="4" fill="%23654321"/><rect x="513" y="318" width="4" height="4" fill="%23654321"/><polygon points="300,200 250,250 350,250" fill="%23B22222"/><rect x="275" y="250" width="50" height="50" fill="%23DEB887"/><rect x="285" y="270" width="10" height="15" fill="%23654321"/><rect x="305" y="260" width="12" height="12" fill="%2387CEEB"/><polygon points="700,220 650,270 750,270" fill="%23800080"/><rect x="675" y="270" width="50" height="55" fill="%23F0E68C"/><rect x="685" y="290" width="10" height="18" fill="%23654321"/><rect x="705" y="280" width="12" height="12" fill="%2387CEEB"/><polygon points="150,180 100,230 200,230" fill="%23FF6347"/><rect x="125" y="230" width="50" height="45" fill="%23FFEFD5"/><rect x="135" y="250" width="8" height="15" fill="%23654321"/><rect x="150" y="240" width="12" height="12" fill="%2387CEEB"/><polygon points="850,190 800,240 900,240" fill="%23FFD700"/><rect x="825" y="240" width="50" height="50" fill="%23F5F5DC"/><rect x="835" y="260" width="10" height="15" fill="%23654321"/><rect x="855" y="250" width="12" height="12" fill="%2387CEEB"/><circle cx="100" cy="600" r="15" fill="%23FFD700"/><circle cx="200" cy="580" r="12" fill="%23FF69B4"/><circle cx="300" cy="620" r="18" fill="%23FF4500"/><circle cx="400" cy="590" r="14" fill="%2300CED1"/><circle cx="500" cy="610" r="16" fill="%23BA55D3"/><circle cx="600" cy="595" r="13" fill="%23FF1493"/><circle cx="700" cy="615" r="17" fill="%2332CD32"/><circle cx="800" cy="585" r="15" fill="%23FF8C00"/><circle cx="900" cy="605" r="12" fill="%236A5ACD"/><circle cx="1000" cy="575" r="19" fill="%23DC143C"/><circle cx="1100" cy="625" r="14" fill="%2320B2AA"/></svg>'),
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 165, 0, 0.08) 0%, transparent 50%);
            background-size: cover, contain, 600px, 800px;
            background-position: center, center, left bottom, right top;
            background-repeat: no-repeat;
            min-height: 100vh;
            padding: 20px;
        }

        .chat-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .chat-frame {
            background: linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,215,0,0.08) 100%);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,215,0,0.4);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
        }

        .chat-container {
            width: 450px;
            height: 650px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .chat-header {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            border: 2px solid #1a1a1a;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlide 0.4s ease-out;
        }

        @keyframes messageSlide {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .bot-message {
            background: #f5f5f5;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .user-message {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            font-weight: 500;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            background: #f5f5f5;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input {
            border-top: 1px solid #eee;
            padding: 20px;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eee;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #FFD700;
            box-shadow: 0 0 0 3px rgba(255,215,0,0.1);
        }

        #sendButton {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
        }

        #sendButton:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: scale(1.05);
        }

        #sendButton:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-action {
            background: transparent;
            border: 1px solid #FFD700;
            color: #1a1a1a;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .quick-action:hover {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        @media (max-width: 768px) {
            .chat-section {
                padding: 10px;
                min-height: 90vh;
            }
            
            .chat-frame {
                padding: 15px;
                border-radius: 20px;
            }
            
            .chat-container {
                width: 100%;
                max-width: 380px;
                height: 70vh;
                border-radius: 15px;
            }

            .quick-actions {
                flex-direction: column;
            }

            .quick-action {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-section">
        <div class="chat-frame">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="status-indicator"></div>
                    <h2>Listplicity Assistant</h2>
                    <p>üè† Let's find the perfect real estate solution for you. üòä</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot-message">
                        üéâ Hey there! Welcome to the future of real estate! I'm here to help you save THOUSANDS on your next move. 
                        
                        Quick question - are you looking to <strong>sell your home</strong> and pocket more cash, or <strong>buy a home</strong> without the traditional hassles? 
                        
                        Either way, you're about to love what we can do for you! üí∞üè†
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="chat-input">
                    <div class="input-container">
                        <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
                        <button id="sendButton" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="quickReply('I want to sell my home')">Sell My Home</button>
                        <button class="quick-action" onclick="quickReply('I want to buy a home')">Buy a Home</button>
                        <button class="quick-action" onclick="quickReply('Tell me about your fees')">Learn About Fees</button>
                        <button class="quick-action" onclick="quickReply('What areas do you serve?')">Our Areas</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Conversation history
        let conversationHistory = [];
        let userProfile = {};

        // Add message to chat
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        // Hide typing indicator
        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Send message to server
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage(message, true);
            input.value = '';

            // Disable input
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;

            // Show typing indicator
            showTyping();

            try {
                // Send to server
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                
                // Hide typing and add response
                hideTyping();
                addMessage(data.response);
                
                // Update conversation history
                conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: data.response }
                );

                // Extract and store user info
                extractUserInfo(message, data.response);

            } catch (error) {
                hideTyping();
                addMessage('Sorry, I\'m having trouble connecting right now. Please try again in a moment.', false);
                console.error('Chat error:', error);
            }

            // Re-enable input
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
        }

        // Quick reply function
        function quickReply(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // Extract user information and send to GHL
        function extractUserInfo(userMessage, botResponse) {
            const message = userMessage.toLowerCase();
            
            // Extract email
            const emailMatch = userMessage.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) userProfile.email = emailMatch[0];
            
            // Extract phone
            const phoneMatch = userMessage.match(/\d{3}[-.]?\d{3}[-.]?\d{4}/);
            if (phoneMatch) userProfile.phone = phoneMatch[0];
            
            // Extract name
            if (message.includes('my name is') || message.includes('i\'m ')) {
                const nameMatch = userMessage.match(/(?:my name is|i'm|i am)\s+([a-zA-Z\s]+)/i);
                if (nameMatch) userProfile.name = nameMatch[1].trim();
            }

            // Determine intent
            if (message.includes('sell')) userProfile.intent = 'seller';
            if (message.includes('buy')) userProfile.intent = 'buyer';

            // Extract address/area
            if (message.includes('in ') || message.includes('from ')) {
                const areaMatch = userMessage.match(/(?:in|from)\s+([a-zA-Z\s,]+)/i);
                if (areaMatch) userProfile.area = areaMatch[1].trim();
            }

            // Check if we have enough info to send to GHL
            if (userProfile.name && userProfile.email && userProfile.intent) {
                sendToGHL(userProfile);
            }

            // Store profile data
            localStorage.setItem('listplicity_user_profile', JSON.stringify(userProfile));

            // Handle MLS app access for buyers
            if (botResponse && botResponse.toLowerCase().includes('mls') && userProfile.intent === 'buyer') {
                setTimeout(async () => {
                    try {
                        const mlsResponse = await fetch('/api/mls-url');
                        const mlsData = await mlsResponse.json();
                        
                        addMessage(`üè† Perfect! Here's your exclusive access to our MLS search platform: <a href="${mlsData.url}" target="_blank" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1a1a; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 10px;">Access MLS Search</a>`, false);
                    } catch (error) {
                        console.error('MLS URL fetch error:', error);
                    }
                }, 2000);
            }
        }

        // Send lead to GHL
        async function sendToGHL(profileData) {
            try {
                await fetch('/api/lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });
                console.log('Lead sent to GHL successfully');
            } catch (error) {
                console.error('Failed to send lead to GHL:', error);
            }
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved user profile
            const savedProfile = localStorage.getItem('listplicity_user_profile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
            }
        });
    </script>
</body>
</html>
