<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Listplicity Assistant</title>
  <style>
    :root{
      /* Listplicity brand */
      --blk:#0a0a0a;        /* near-black */
      --bg:#111213;         /* page background */
      --card:#121416;       /* card bg */
      --card2:#171a1d;      /* soft gradient */
      --text:#f7f7f7;       /* primary text */
      --muted:#b7bec8;      /* secondary text */
      --line:#2b2f36;       /* borders */
      --gold:#d4af37;       /* brand gold */
      --gold2:#f7d774;      /* light gold */
      --accent:#27c07d;     /* success pop for progress complete */
      --shadow:0 24px 60px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    main{max-width:960px;margin:36px auto;padding:0 18px}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--gold),var(--gold2));display:grid;place-items:center;color:#111;font-weight:900}
    h1{margin:0;font-size:24px;letter-spacing:.3px}
    p.sub{margin:6px 0 20px;color:var(--muted)}

    /* Card / Chat */
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      display:flex;gap:12px;align-items:center;
      padding:16px 18px;background:linear-gradient(180deg,#0f1113,#0c0d0f);
      border-bottom:1px solid var(--line);
    }
    .title{font-weight:800}
    .subtle{font-size:12px;color:var(--muted)}
    .bar{height:6px;background:#0f141a;border-bottom:1px solid var(--line)}
    .bar>div{
      height:100%;width:0;
      background:linear-gradient(90deg,var(--gold),var(--gold2));
      transition:width .25s ease;
    }

    .body{
      height:70vh;max-height:780px;min-height:520px;
      overflow:auto;padding:16px;
      background:linear-gradient(180deg,#0f1113,#101317);
      display:flex;flex-direction:column;gap:12px;
    }
    .row{display:flex;gap:10px;align-items:flex-end}
    .row.me{justify-content:flex-end}
    .bubble{
      max-width:78%;
      padding:12px 14px;border-radius:14px;
      border:1px solid #262b32;
      background:#151a20;color:var(--text);
      font-size:15px;line-height:1.4;white-space:pre-wrap;
    }
    .row.me .bubble{
      background:#181e25;border-color:#323944;
    }
    .choices{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      padding:8px 12px;font-size:14px;border-radius:999px;
      background:#0f1317;color:var(--text);border:1px solid #323944;cursor:pointer;
    }
    .chip:hover{border-color:#46505c}

    .typing{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px}
    .dot{width:6px;height:6px;border-radius:50%;background:#6d7785;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.35}40%{opacity:1}}

    .compose{
      display:flex;gap:10px;padding:12px;background:#0f1215;border-top:1px solid var(--line)
    }
    .in{
      flex:1;padding:12px 14px;border:1px solid #2a2f36;border-radius:12px;font-size:15px;
      background:#151a1f;color:var(--text);
    }
    .send{
      background:linear-gradient(180deg,var(--gold),var(--gold2));
      color:#111;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;
      box-shadow:0 8px 22px rgba(212,175,55,.2);
    }

    /* subtle “in-frame” border accent */
    .frame{
      border-top:2px solid var(--gold);
      border-bottom:2px solid #3a3120; /* darker gold shadow */
    }

    @media (max-width:640px){
      main{margin:0;max-width:none}
      .body{height:calc(100vh - 180px);min-height:460px}
    }
  </style>
</head>
<body>
  <main>
    <div class="brand">
      <div class="logo">L</div>
      <div>
        <h1>Listplicity Assistant</h1>
        <p class="sub">Friendly, real-time help · MLS access & 1% Listing (Limited Services)</p>
      </div>
    </div>

    <div class="card frame" role="dialog" aria-label="Listplicity Chat">
      <div class="head">
        <div class="logo" style="width:32px;height:32px;border-radius:10px;font-size:14px">L</div>
        <div>
          <div class="title">We’re glad you’re here</div>
          <div class="subtle">Ask anything — I’ll also get you set up fast.</div>
        </div>
      </div>
      <div class="bar"><div id="pbar"></div></div>
      <div class="body" id="log" aria-live="polite"></div>
      <div class="compose">
        <input id="in" class="in" placeholder="Type your message… (Enter)" autocomplete="off"/>
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const API = window.location.origin; // same Render host
    const log = document.getElementById('log');
    const pbar = document.getElementById('pbar');
    const input = document.getElementById('in');
    const send = document.getElementById('send');

    const transcript = [];                   // { role:'user'|'assistant', content:string }
    const state = { path:null, answers:{} }; // accumulated fields

    function add(role, text, opts={}){
      const row = document.createElement('div');
      row.className = 'row' + (role==='me' ? ' me' : '');
      const b = document.createElement('div');
      b.className = 'bubble'; b.textContent = text;
      row.appendChild(b);

      if (opts.choices) {
        const wrap = document.createElement('div');
        wrap.className = 'choices';
        opts.choices.forEach(c=>{
          const chip = document.createElement('button');
          chip.className='chip'; chip.type='button'; chip.textContent=c.label;
          chip.onclick=()=> handleUser(c.value || c.label, c.label);
          wrap.appendChild(chip);
        });
        b.appendChild(wrap);
      }

      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }

    function typing(on){
      const id = 'typing-row';
      if (on) {
        if (document.getElementById(id)) return;
        const row = document.createElement('div');
        row.className='row';
        row.id=id;
        row.innerHTML='<div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>';
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
      } else {
        const r = document.getElementById(id);
        if (r) r.remove();
      }
    }

    function progress(){
      const req = ['path','name','email','phone'];
      const have = req.filter(k => k==='path' ? !!state.path : !!state.answers[k]);
      pbar.style.width = Math.round(have.length/req.length*100) + '%';
      if (have.length === req.length) {
        pbar.style.background = 'linear-gradient(90deg, var(--accent), #5ee1a7)';
      }
    }

    async function welcome(){
      try{
        const r = await fetch(API + '/api/welcome');
        const data = await r.json();
        add('bot', data.bot_text || "Welcome to Listplicity! How can I help?");
      }catch{
        add('bot', "Welcome to Listplicity! How can I help?");
      }
      progress();
    }

    async function toLLM(userText){
      typing(true);
      try{
        const resp = await fetch(API + '/api/chat', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ history: transcript.slice(-12), state })
        });
        const data = await resp.json();

        if (data.state_patch?.path) state.path = data.state_patch.path;
        if (data.state_patch?.answers) Object.assign(state.answers, data.state_patch.answers);
        if (data.state_patch?.tag) state.tag = data.state_patch.tag;

        typing(false);
        add('bot', data.bot_text || 'Okay.');
        transcript.push({role:'assistant', content: data.bot_text || ''});
        progress();

        if (data.action === 'submit') await submitLead();
      }catch(e){
        typing(false);
        add('bot', 'I hit a snag—mind trying again?');
        console.error(e);
      }
    }

    async function submitLead(){
      add('bot', 'Sending this over now…');
      try{
        const r = await fetch(API + '/api/lead', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            path: state.path,
            answers: state.answers,
            tag: state.tag || null,
            ts: new Date().toISOString(),
            userAgent: navigator.userAgent
          })
        });
        if(!r.ok) throw new Error();
        add('bot', 'Done ✅ We’ll follow up shortly. Want to book a quick call while I have you?');
        pbar.style.width='100%';
      }catch{
        add('bot','Hmm—couldn’t send just now. Want to drop your number/email and I’ll make sure it goes through?');
      }
    }

    async function handleUser(value, labelShown){
      const text = labelShown || value;
      add('me', text);
      transcript.push({role:'user', content: value});
      input.value='';
      await toLLM(value);
    }

    send.addEventListener('click', ()=>{ const v=input.value.trim(); if(v) handleUser(v); });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); const v=input.value.trim(); if(v) handleUser(v); }});

    // boot
    welcome();
  })();
  </script>
</body>
</html>
